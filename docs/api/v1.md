# Spice API
## Version `v1`


All routes are prefixed with `/api/v1/`


Example: `GET localhost:1234/api/v1/processes`


## Host System Info


### `GET /filesystem/:path*`
Gets the file(s) within the given path


Path parameters:
 - `path` {string}: URL encoded path to a file or directory.  If empty, refers to the root directory.


Responses:
 - `200`: Successfully got contents of path.
    - Returns {[File](#file)}
 - `400`: Invalid path.
    - Returns {[Error](#error)}
 - `403`: Insufficient privileges to open file.
    - Returns {[Error](#error)}
 - `404`: File doesn't exist.
    - Returns {[Error](#error)}


### `GET /processes`
Gets the list of processes running on the host machine.


Responses:
 - `200`: Successfully got list of processes.
    - Returns {[Process](#process)[]}
 - `403`: Insufficient privileges to complete operation.
    - Returns {[Error](#error)}


# Debug
All `/debug` routes are stateful--their responses are based on the currently attached process/executable.
If the debugger is not attached, these endpoints respond with `409 Conflict`. None of the `/debug` routes respond with `409` for any other reason.


### `POST /debug/attach/pid/:pid`
Attach to a running process. If a process was already attached, detaches from that process.
Path parameters:
 - `pid` {integer}: PID of a running process


Responses:
 - `200`: Successfully attached to process.
    - Returns {[AttachInfo](#attachInfo)} 
 - `400`: Invalid PID
     - Returns {[Error](#error)}
 - `404`: Process with PID not found
    - Returns {[Error](#error)}


### `POST /debug/attach/bin/:path*`
Attach to a binary, so it can be executed. Returns path to source code.


Path parameters:
 - `path` {string}: Path to binary to run and attach to.


Responses:
 - `200`: Successfully ran and attached to binary.
     - Returns {[AttachInfo](#attachInfo)} 
 - `400`: Invalid path.
     - Returns {[Error](#error)}
 - `404`: No binary exists at given path. 
     - Returns {[Error](#error)}


### `GET /debug`
Returns information about the attached process or executable.


Responses:
 - `200`: Is attached to process.
     - Returns {[AttachInfo](#attachInfo)} 


## Functions


### `GET /debug/functions`
Returns a list of debuggable functions in the attached process.


Responses:
 - `200`: Successfully got list of functions.
     - Returns {string[]}: List of function identifiers. 


### `GET /debug/functions/:function`
Returns information about the function, including source file path and input parameter types.


Path parameters:
 - `function` {string}: Function identifier.


Responses:
 - `200`: Got info for specified function.
     - Returns {[Function](#function)} 
 - `400`: Badly formatted function identifier.
     - Returns {[Error](#error)}
 - `404`: No function of that identifier found. 
     - Returns {[Error](#error)}


## Breakpoints


### `GET /debug/breakpoints`
Lists breakpoints.


Responses:
 - `200`: Got list of breakpoints.
     - Returns {[Breakpoint](#breakpoint)[]}: List of zero or more breakpoints set.


### `PUT /debug/breakpoints/:function`
Sets a breakpoint on this function.


Path parameters:
 - `function` {string}: Function identifier.


Response:
 - `200`: Successfully set breakpoint at function.
     - Returns {[Breakpoint](#breakpoint)}
 - `400`: Badly formatted function identifier.
     - Returns {[Error](#error)}
 - `404`: No function of that identifier found. 
     - Returns {[Error](#error)}


### `DELETE /debug/breakpoints/:function`
Removes breakpoint on this function.


Path parameters:
 - `function` {string}: Function identifier.


Response:
 - `200`: Successfully removed breakpoint at function.
 - `400`: Badly formatted function identifier.
     - Returns {[Error](#error)}
 - `404`: No function of that identifier found. 
     - Returns {[Error](#error)}
 - `410`: There was no breakpoint on that function to begin with.
     - Returns {[Error](#error)}




### `POST /debug/execute`
Launches the process if it is not running or continues execution until the next breakpoint.

Produces a `process` execution, which can be used with `/debug/executions/:executionId/trace` to get `stdout` of the process.
The execution terminates when the program terminates or hits a breakpoint.

Returns:
 - `202`: Successfully started execution 
     - Returns an [Execution](#execution)

### `POST /debug/functions/:function/execute`
Executes the function with parameters provided in POST body.

Path parameters:
 - `function` {string}: Function identifier.


Returns:
 - `202`: Execution began successfully
    - Returns an [Execution](#execution).
 - `400`: Invalid function
 - `404`: Function not found


## Executions
An execution represents a chunk of program state and output produced as the program is run. There are two types of Executions--`function`, which is a fully traceable, debuggable execution, and `process`, which only contains `stdout` trace objects.


“Function” executions are produced when the process hits a breakpoint or the user executes a standalone function.
“Process” executions are produced by the `/debug/execute` endpoint. If the execution enters a function with a breakpoint, it terminates and creates a new “function” execution, setting the `nextExecution` field to point to the new function execution.


### `GET/debug/executions`
Get a list of executions since we attached to this process. The server may delete executions data from the current process at any time.


Responses:
 - `200`
    - Returns {[Execution](#execution)[]}


### `GET /debug/executions/:executionId`
Get information about an execution status.


Path parameters:
 - `executionId`: Execution id


Responses:
 - `200`
    - Returns {[Execution](#execution)}
 - `400`: Invalid execution id
    - Returns {[Error](#error)]}
 - `404`: Execution id not found
    - Returns {[Error](#error)]}


### `GET /debug/executions/:executionId/trace`
Get trace data for the execution.


Path parameters:
 - `executionId`: Execution id


Responses:
 - `200`
    - Returns a stream of {[Trace](#trace)[]}. The body begins with an open bracket `[` on its own line. Each Trace is on its own line. If the execution is still `executing`, new lines will be streamed as they are produced. When the execution is finished the last Trace object has `tType=2 (termination)` and describes how the execution terminated. The final line of the body contains `]`, then the response is closed.
 - `400`: Invalid execution id
    - Returns {[Error](#error)]}
 - `404`: Execution id not found
    - Returns {[Error](#error)]}


### `POST /debug/executions/:executionId/stop`
Halts a long running Execution.


Responses:
 - `200`: Execution stopped, or was already stopped or finished
    - Returns {[Execution](#execution)}
 - `400`: Invalid execution id
    - Returns {[Error](#error)]}
 - `404`: Execution id not found
    - Returns {[Error](#error)]}


## Object Definitions


### Error
```
{
   code {integer}: Unique code identifying this error type
   name {string}: Unique human readable name for this error type
   message {string}: Human readable error message
   data {object}: Data specific to this error. See [Error Codes](#error-codes) for specifics.
}
```




### File
```
{
    name {string}: Name of file
    path {string}: Path to file
    ftype {string}: File type ("file" or "directory")
    contents: {object[]}:
        If ftype="file", undefined
        If ftype="directory", an array of Files inside the directory. Subdirectories have "contents" field set to undefined so the entire directory subtree is not returned.
}
```


### Process
```
{
    id {int}: Identifying number of process on host machine
    name {string}: Name of process on host machine
}
```


### Execution
```
{
   id {integer}: Unique Identifier
   eType {string}: Type of execution. Either `function` or `process`
   status {string}: Either `pending`, `executing`, `stopped`, or `done`
   executionTime {integer}: Nanoseconds
   data {object}: Data specific to this eType
      if `eType=function`: {
         function {[Function](#function)}: Function that produced this execution
      }
      if `eType=process`: {
         nextExecution {Execution id}: Id of the execution that follows this one. Null until `status=done`. Initially set to `null`, set when a call to `/debug/execute` hits a breakpoint, in which case it points to the breakpoint function’s execution.
      }
}
```


### Trace
```
{
   index {integer}: Index of the trace, beginning at 0 and totally ordered for each execution
   tType {integer}: Type of trace: `0`=instruction (state changes), `1`=output (to stdout), `2`=termination (data about how the execution ended)
   line {integer}: Line number that produced this trace
   data {object}: Data specific to the trace tType
      if `tType=0`: {
         state {object[]}: Array of variable changes {variable {Variable}, value {*}}
      }
      If `tType=1`: {
         output {string}: Stdout output
      }
      If `tType=2`: {
         cause {string}: Reason for termination. Either `stopped`, `crashed`, `ended`, or `breakpoint`
         stack {string} (defined if cause=crashed): Stack trace output
         code {integer} (defined if cause=ended): Program exit code
         nextExecution {Execution id} (defined if cause=breakpoint): Id of the following function execution
      }
}
```


### Function
```
{
   address {integer}: Memory address of the function
   name {string}: Name of the function
   sourcePath {string}: Full path to the source code
   lineNumber {integer}: Line number of the function definition
   lineCount {integer}: Length of function in source code lines
   parameters {object[]}: Array of function parameter objects--{name {string}, sType {SourceType}}
}
```
### AttachInfo
```
{
  attachedProcess {[Process](#process)}
}
```
### Breakpoint
```
{
  function {[Function](#Function)}: The function that this is breakpoint is associated with.
  metadata {string}: Any additional info associated with this breakpoint.
}
```
### Variable
```
{
  id {var id}: Unique identifier of that variable.
  name {string}: Name of the variable as it appears in the function.
  sType {SourceType}: Type of the variable as it is defined in the source code.
  address {integer}: Memory address
  data {*}: The data within the variable.
}

### SourceType
TODO
```


## Error Codes


- `0`: Unknown error.
 - Data: undefined
- `1`: Internal server error.
    - Data: {stack {string}: stack trace from when the error occurred}


TODO: create error codes for more or less every unique error the system can produce. Not part of the prototype, maybe we won’t end up doing this in the final product.
